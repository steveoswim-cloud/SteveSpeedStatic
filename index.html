<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strava Run Analyzer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.5.0/Recharts.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
        var useState = React.useState;
        var useEffect = React.useEffect;
        var e = React.createElement;

        function StravaAnalyzer() {
            var stateActivities = useState([]);
            var activities = stateActivities[0];
            var setActivities = stateActivities[1];
            
            var stateLoading = useState(false);
            var loading = stateLoading[0];
            var setLoading = stateLoading[1];
            
            var stateError = useState('');
            var error = stateError[0];
            var setError = stateError[1];
            
            var stateAccessToken = useState('');
            var accessToken = stateAccessToken[0];
            var setAccessToken = stateAccessToken[1];
            
            var stateStep = useState('setup');
            var step = stateStep[0];
            var setStep = stateStep[1];
            
            var stateClientId = useState('');
            var clientId = stateClientId[0];
            var setClientId = stateClientId[1];
            
            var stateClientSecret = useState('');
            var clientSecret = stateClientSecret[0];
            var setClientSecret = stateClientSecret[1];
            
            var stateAuthCode = useState('');
            var authCode = stateAuthCode[0];
            var setAuthCode = stateAuthCode[1];
            
            var stateExchanging = useState(false);
            var exchanging = stateExchanging[0];
            var setExchanging = stateExchanging[1];

            useEffect(function() {
                var urlParams = new URLSearchParams(window.location.search);
                var code = urlParams.get('code');
                if (code) {
                    setAuthCode(code);
                    setStep('exchange');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }, []);

            function exchangeToken() {
                if (!clientId || !clientSecret || !authCode) {
                    setError('Please fill in all fields');
                    return;
                }

                setExchanging(true);
                setError('');

                var proxyUrl = 'https://corsproxy.io/?';
                var tokenUrl = 'https://www.strava.com/oauth/token';
                
                var params = new URLSearchParams({
                    client_id: clientId.trim(),
                    client_secret: clientSecret.trim(),
                    code: authCode.trim(),
                    grant_type: 'authorization_code'
                });

                fetch(proxyUrl + encodeURIComponent(tokenUrl), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                })
                .then(function(response) {
                    if (!response.ok) {
                        return response.json().then(function(errorData) {
                            throw new Error(errorData.message || 'Token exchange failed');
                        });
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (data.access_token) {
                        setAccessToken(data.access_token);
                        setStep('analyze');
                        setError('');
                    } else {
                        throw new Error('No access token received');
                    }
                })
                .catch(function(err) {
                    setError(err.message);
                })
                .finally(function() {
                    setExchanging(false);
                });
            }

            function fetchActivities() {
                if (!accessToken) {
                    setError('No access token available');
                    return;
                }

                setLoading(true);
                setError('');

                var proxyUrl = 'https://corsproxy.io/?';
                var stravaUrl = 'https://www.strava.com/api/v3/athlete/activities?per_page=100';
                
                fetch(proxyUrl + encodeURIComponent(stravaUrl), {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                })
                .then(function(response) {
                    if (!response.ok) {
                        if (response.status === 401) {
                            throw new Error('Access token expired');
                        }
                        throw new Error('Failed to fetch activities');
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (!Array.isArray(data)) {
                        throw new Error('Unexpected response format');
                    }

                    var runActivities = data
                        .filter(function(activity) { 
                            return activity.type === 'Run' || activity.type === 'TrailRun';
                        })
                        .slice(0, 20)
                        .map(function(activity) {
                            return {
                                id: activity.id,
                                name: activity.name,
                                type: activity.type,
                                date: new Date(activity.start_date).toLocaleDateString(),
                                distance: (activity.distance / 1000).toFixed(2),
                                duration: Math.round(activity.moving_time / 60),
                                pace: (activity.moving_time / 60 / (activity.distance / 1000)).toFixed(2),
                                elevation: Math.round(activity.total_elevation_gain)
                            };
                        });

                    if (runActivities.length === 0) {
                        setError('No run activities found');
                    } else {
                        setActivities(runActivities);
                    }
                })
                .catch(function(err) {
                    setError(err.message);
                })
                .finally(function() {
                    setLoading(false);
                });
            }

            var stats = activities.length > 0 ? {
                totalDistance: activities.reduce(function(sum, a) { return sum + parseFloat(a.distance); }, 0).toFixed(2),
                totalTime: activities.reduce(function(sum, a) { return sum + a.duration; }, 0),
                avgPace: (activities.reduce(function(sum, a) { return sum + parseFloat(a.pace); }, 0) / activities.length).toFixed(2),
                totalElevation: activities.reduce(function(sum, a) { return sum + a.elevation; }, 0)
            } : null;

            var redirectUri = window.location.origin + window.location.pathname;
            var authUrl = 'https://www.strava.com/oauth/authorize?client_id=' + clientId + 
                          '&response_type=code&redirect_uri=' + encodeURIComponent(redirectUri) + 
                          '&approval_prompt=force&scope=activity:read_all';

            return e('div', { className: 'min-h-screen bg-gradient-to-br from-orange-50 to-orange-100 p-4 sm:p-8' },
                e('div', { className: 'max-w-7xl mx-auto' },
                    e('div', { className: 'bg-white rounded-xl shadow-lg p-6 mb-6' },
                        e('h1', { className: 'text-3xl font-bold text-orange-600 mb-2' }, 'Strava Run Analyzer'),
                        e('p', { className: 'text-gray-600 mb-6' }, 'Analyze your last 20 run and trail run activities'),
                        
                        step === 'setup' && e('div', { className: 'space-y-4' },
                            e('div', { className: 'bg-blue-50 border border-blue-200 rounded-lg p-4' },
                                e('h3', { className: 'font-semibold text-blue-900 mb-2 text-sm' }, 'Setup Instructions:'),
                                e('ol', { className: 'text-xs text-blue-800 space-y-2 ml-5 list-decimal' },
                                    e('li', null, 
                                        'Go to ',
                                        e('a', { 
                                            href: 'https://www.strava.com/settings/api', 
                                            target: '_blank',
                                            className: 'underline font-medium'
                                        }, 'Strava API Settings'),
                                        ' and create an API application'
                                    ),
                                    e('li', null, 'Copy your Client ID and paste it below'),
                                    e('li', null, 'Click "Authorize with Strava"')
                                )
                            ),
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Client ID'),
                                e('input', {
                                    type: 'text',
                                    value: clientId,
                                    onChange: function(ev) { setClientId(ev.target.value); },
                                    placeholder: 'Your Strava Client ID',
                                    className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none'
                                })
                            ),
                            clientId && e('div', { className: 'bg-green-50 border border-green-200 rounded-lg p-4' },
                                e('p', { className: 'text-sm font-medium text-green-900 mb-2' }, 'Ready to Authorize!'),
                                e('a', {
                                    href: authUrl,
                                    className: 'inline-block px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition font-medium text-sm'
                                }, 'Authorize with Strava')
                            )
                        ),
                        
                        step === 'exchange' && e('div', { className: 'space-y-4' },
                            e('div', { className: 'bg-green-50 border border-green-200 rounded-lg p-4' },
                                e('p', { className: 'text-sm text-green-800' }, '✓ Authorization code received!')
                            ),
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Client ID'),
                                e('input', {
                                    type: 'text',
                                    value: clientId,
                                    onChange: function(ev) { setClientId(ev.target.value); },
                                    placeholder: 'Your Strava Client ID',
                                    className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none'
                                })
                            ),
                            e('div', null,
                                e('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'Client Secret'),
                                e('input', {
                                    type: 'password',
                                    value: clientSecret,
                                    onChange: function(ev) { setClientSecret(ev.target.value); },
                                    placeholder: 'Your Strava Client Secret',
                                    className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none'
                                })
                            ),
                            e('button', {
                                onClick: exchangeToken,
                                disabled: exchanging,
                                className: 'w-full px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:bg-gray-400 transition font-semibold'
                            }, exchanging ? 'Exchanging...' : 'Get Access Token'),
                            error && e('div', { className: 'p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm' }, 
                                e('strong', null, 'Error: '), error
                            )
                        ),
                        
                        step === 'analyze' && e('div', { className: 'space-y-4' },
                            e('div', { className: 'bg-green-50 border border-green-200 rounded-lg p-4' },
                                e('p', { className: 'text-sm text-green-800' }, '✓ Access token obtained!')
                            ),
                            e('button', {
                                onClick: fetchActivities,
                                disabled: loading,
                                className: 'w-full px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:bg-gray-400 transition font-semibold'
                            }, loading ? 'Loading Activities...' : 'Fetch My Activities'),
                            error && e('div', { className: 'p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm' }, 
                                e('strong', null, 'Error: '), error
                            )
                        )
                    ),
                    
                    stats && e('div', { className: 'grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6' },
                        e('div', { className: 'bg-white rounded-lg shadow-md p-4' },
                            e('p', { className: 'text-gray-500 text-xs mb-1' }, 'Total Distance'),
                            e('p', { className: 'text-2xl font-bold text-orange-600' }, stats.totalDistance),
                            e('p', { className: 'text-gray-400 text-xs' }, 'km')
                        ),
                        e('div', { className: 'bg-white rounded-lg shadow-md p-4' },
                            e('p', { className: 'text-gray-500 text-xs mb-1' }, 'Total Time'),
                            e('p', { className: 'text-2xl font-bold text-orange-600' }, Math.round(stats.totalTime / 60)),
                            e('p', { className: 'text-gray-400 text-xs' }, 'hours')
                        ),
                        e('div', { className: 'bg-white rounded-lg shadow-md p-4' },
                            e('p', { className: 'text-gray-500 text-xs mb-1' }, 'Avg Pace'),
                            e('p', { className: 'text-2xl font-bold text-orange-600' }, stats.avgPace),
                            e('p', { className: 'text-gray-400 text-xs' }, 'min/km')
                        ),
                        e('div', { className: 'bg-white rounded-lg shadow-md p-4' },
                            e('p', { className: 'text-gray-500 text-xs mb-1' }, 'Total Elevation'),
                            e('p', { className: 'text-2xl font-bold text-orange-600' }, stats.totalElevation),
                            e('p', { className: 'text-gray-400 text-xs' }, 'meters')
                        )
                    ),
                    
                    activities.length > 0 && e('div', { className: 'bg-white rounded-lg shadow-md p-4' },
                        e('h2', { className: 'text-lg font-bold text-gray-800 mb-4' }, 'Activity Details'),
                        e('div', { className: 'overflow-x-auto' },
                            e('table', { className: 'w-full text-sm' },
                                e('thead', null,
                                    e('tr', { className: 'border-b-2 border-gray-200' },
                                        e('th', { className: 'text-left py-2 px-2 text-gray-600 font-semibold' }, 'Date'),
                                        e('th', { className: 'text-left py-2 px-2 text-gray-600 font-semibold' }, 'Name'),
                                        e('th', { className: 'text-left py-2 px-2 text-gray-600 font-semibold' }, 'Type'),
                                        e('th', { className: 'text-right py-2 px-2 text-gray-600 font-semibold' }, 'Distance (km)'),
                                        e('th', { className: 'text-right py-2 px-2 text-gray-600 font-semibold' }, 'Time (min)'),
                                        e('th', { className: 'text-right py-2 px-2 text-gray-600 font-semibold' }, 'Pace'),
                                        e('th', { className: 'text-right py-2 px-2 text-gray-600 font-semibold' }, 'Elev (m)')
                                    )
                                ),
                                e('tbody', null,
                                    activities.map(function(activity) {
                                        return e('tr', { key: activity.id, className: 'border-b border-gray-100 hover:bg-orange-50' },
                                            e('td', { className: 'py-2 px-2' }, activity.date),
                                            e('td', { className: 'py-2 px-2 font-medium' }, activity.name),
                                            e('td', { className: 'py-2 px-2' },
                                                e('span', { 
                                                    className: 'px-2 py-1 rounded-full text-xs ' + 
                                                    (activity.type === 'TrailRun' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700')
                                                }, activity.type === 'TrailRun' ? 'Trail' : 'Run')
                                            ),
                                            e('td', { className: 'py-2 px-2 text-right' }, activity.distance),
                                            e('td', { className: 'py-2 px-2 text-right' }, activity.duration),
                                            e('td', { className: 'py-2 px-2 text-right' }, activity.pace),
                                            e('td', { className: 'py-2 px-2 text-right' }, activity.elevation)
                                        );
                                    })
                                )
                            )
                        )
                    )
                )
            );
        }

        var root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(StravaAnalyzer));
    </script>
</body>
</html>
